rm(list=ls())
setwd("~/project/CirDatabase_020824/Plots_RNA-seq")
library(openxlsx)
library(data.table)
library(dplyr)
#condition=read.xlsx("/workspace/rsrch2/panpanliu/project/CirDatabase_020824/MetacycleR/RNA-seq.condition.xlsx",sheet = 1) 
condition = read.xlsx("/workspace/rsrch2/panpanliu/project/CirDatabase_020824/MetacycleR/MetaInfor20250310.condition.xlsx",sheet = 1) 
condition = condition %>% filter(LibraryType == "RNA-Seq" | LibraryType =="Microarray") %>% filter(Tissue !="cell line")

all_gene_ID=read.delim("/workspace/rsrch1/tmp/DataBase_datatable0618/metaInfo_Folder/3Organism_geneID.txt",header = T,stringsAsFactors = F)
all_gene_ID = all_gene_ID %>% filter(Gene !="") %>% mutate(loci=paste0(Chr,":",Start,"-",End))%>%select(loci,ensembl_transcript_id,ensembl_gene_id,Gene,Organism) %>% unique()
rownames(all_gene_ID)=all_gene_ID$ensembl_transcript_id
Gene_ensemble = all_gene_ID %>% group_by(Gene) %>% select(Gene,ensembl_gene_id,loci) %>% slice(1)
rownames(Gene_ensemble)=Gene_ensemble$Gene

metafile_path = "/workspace/rsrch1/tmp/DataBase_datatable0618/MetaCycle/APA_results/MetacycleR/metaCycle_Res/MetaResults_Expression"

library(ggplot2)
library(grid)
condition_metaout=condition

#Organism Tissue Condition Gene  Gene position   metacycle_pvalue  metacycle_BH.Q  metacycle_AMP metacycle_phase GSEID

geneplotfie = function(gene,df=df){
  colors <- c("red")
  df.tmp=df %>% dplyr::filter(Gene == gene)
  if(nrow(df.tmp)==1){
  exp=df.tmp%>% select(Gene,colnames(df)[grep(".*[ZT|CT|T|hr|H][0-9].*",colnames(df))]) 
  p=format(df.tmp$metacycle_pvalue, scientific = TRUE,digits = 2)
  #plotfile=paste0("/workspace/rsrch1/tmp/DataBase_datatable0618/database_plots/Transcript/",df.tmp$plot)
  plotfile=paste0(getwd(),"/",df.tmp$plot)
  amp=sprintf("%.1f", signif(df.tmp$metacycle_AMP,digits = 1))
  wide_df <- reshape2::melt(exp, id.vars = c("Gene"), variable.name = "sample", 
                  value.name = "expr") 
  
  if(df.tmp$GSEID == "PRJEB16726"){
    wide_df$time=rep(c(12, 18, 24, 30, 36, 42, 48,54,60),each=5)
    } else{
    # wide_Df$time= gsub(".*[ZT|CT|T|hr|H][0-9]+[\\.|_|\\.R\\_R].*" ,"\\1",wide_df$sample)
      wide_df$time=as.numeric(gsub(".*(?:ZT|CT|T|hr|H)([0-9]+).*", "\\1", trimws(wide_df$sample)))
    }

  wide_df2 = wide_df %>% group_by(time) %>% mutate(Tmean=mean(expr))
  Tmin=ifelse(min(wide_df$time)>=12,min(wide_df$time),0)
  Tmax=max(wide_df$time)
  xlim=round(max(wide_df$time)/24)*24
  ylim = ceiling(wide_df$expr)
  shade_intervals <- data.frame(
    xmin = seq(12, xlim, by = 24),  # Start points
    xmax = seq(24, xlim, by = 24),  # End points
    ymin = -Inf,  # Cover full y-axis
    ymax = Inf
  )
  theme <- theme_bw() +
    theme(axis.line = element_blank(),  
          axis.text = element_text(color = "black", size = 6),
          panel.grid = element_blank(),
          panel.border = element_rect(color = "black", fill = NA, linewidth = 0.2), 
          axis.title = element_text(size = 6),
          plot.title = element_text(size = 6),
          axis.ticks = element_line(linewidth = 0.2),
          axis.ticks.length = unit(1.5, "pt"))
  c<-ggplot()+
    #geom_smooth(method = "loess",size = 0.2,se=F,colour = "red",ymin = 0)+
    geom_point(data=wide_df,aes(x=time,y=expr),size=0.2,colour="grey30")+
    geom_line(data=wide_df2,aes(x=time,y=Tmean),colour="red")+
    xlab("Time point")+
    ylab("Expression level") +
    ggtitle("   ")+
    theme(plot.title = element_text(hjust = 0.2), plot.title.position = "plot")+
    scale_x_continuous(limits = c(Tmin,xlim),breaks=seq(Tmin,xlim,6))+expand_limits(x=0)+
    #scale_y_continuous(limits = c(0,ylim),break=pretty(c(0, ylim), n = 5))+
    theme_classic()+
    scale_color_manual(values = colors) + 
    geom_rect(data = shade_intervals, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
              fill = "black", alpha = 0.1, inherit.aes = FALSE) +  # Grey shaded background
    theme(text = element_text(size = 6,color = "black")) +
    theme(legend.position="none")+theme    
  svg(filename=plotfile,width = 1.6, height = 1.5)
  suppressMessages(print(c))
  grid.text(bquote(italic(.(gene))), x = 0.2, y = 0.94, just = "left", gp = gpar(fontsize = 6))
  grid.text(bquote(italic(p) * " = " * .(p) * "   Amp. = " * .(amp)), x = 0.2, y = 0.87, just = "left", gp = gpar(fontsize = 6))
  dev.off()
  }
   }

data_extract <- function(x,gene=gene){
   Org.tmp=condition$Organism[x]
   Tis.tmp=condition$Tissue[x]
   gse.tmp=condition$gseID[x]
   con.tmp=gsub("[\\.\\/\\(\\)]","",condition$Condition[x])
   nsam.tmp=condition$nSample[x]
   file=ifelse(condition$LibraryType[x] == "RNA-Seq",paste0(metafile_path,"/",gse.tmp,"/",condition$metaoutfile[x]),paste0(metafile_path,"/",condition$metaoutfile[x]))
   if(file.exists(file)){
   df0.tmp = fread(file)
   if(names(df0.tmp)[1]=="CycID"){names(df0.tmp)[1]="Gene"}
   df0.tmp=tidyr::separate_rows(df0.tmp,Gene,sep=" /// ")
    pvalue_col=ifelse(length(grep(condition$p_column[x],names(df0.tmp)))>0,condition$p_column[x],intersect(c("meta2d_pvalue","JTK_pvalue","LS_pvalue"),colnames(df0.tmp))[1])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
   amp=colnames(df0.tmp)[grep(gsub("pvalue","amp",pvalue_col[1]),ignore.case = T,colnames(df0.tmp))]
   phase=colnames(df0.tmp)[grep(paste0(gsub("_pvalue","",pvalue_col[1]),".*phase"),ignore.case = T,colnames(df0.tmp))]
   df0.all = df0.tmp %>% group_by(Gene) %>% arrange(.[[pvalue_col]]) %>%slice(1)%>% ungroup()
   if ("Ensembl" %in% names(df0.all)) {
     ensem.tmp <- all_gene_ID$ensembl_gene_id[match(df0.all$Ensembl, all_gene_ID$ensembl_transcript_id)]
     loci.tmp  <- all_gene_ID$loci[match(df0.all$Ensembl, all_gene_ID$ensembl_transcript_id)]
   } else {
     ensem.tmp <- Gene_ensemble$ensembl_gene_id[match(df0.all$Gene, Gene_ensemble$Gene)]
     loci.tmp  <- Gene_ensemble$loci[match(df0.all$Gene, Gene_ensemble$Gene)]
   }
   
   df.all = df0.all %>%         mutate(
                                Organism = Org.tmp,
                                 Tissue = Tis.tmp,
                                 Condition = con.tmp,
                                 Gene=Gene,
                                 ENSEMBL = ensem.tmp,
                                 Loci = loci.tmp,
                                 metacycle_pvalue=.[[pvalue_col]],
                                 metacycle_AMP=.[[amp]],
                                 metacycle_Phase=.[[phase]],
                                 GSEID=gse.tmp,
                                 plot=paste0(paste("Transcript",gsub(" ",".",Org.tmp), gsub(" ",".",Tis.tmp), gsub(" ",".",con.tmp), gse.tmp,Gene, sep = '_'),".svg")
                                ) %>% filter(!(is.na(Loci)))
   Rmean = rowMeans(df.all[,grep(".*[ZT|CT|T|hr|H][0-9].*",colnames(df.all))])
   keep= Rmean >= 1 ##Many large-scale RNA-seq studies (e.g., GTEx, ENCODE) use TPM >1 as a standard expression cutoff
   df.all=df.all[keep,]
   df.table=df.all %>% dplyr::select(Organism,Tissue,Condition,Gene,ENSEMBL,Loci,metacycle_pvalue,metacycle_AMP,metacycle_Phase,GSEID)
   geneplotfie(g=gene, df = df.all)
   write.table(df.table,file=paste0("/workspace/rsrch2/panpanliu/project/CirDatabase_020824/Database_tables02192025/Transcript_tables/",gse.tmp,"_data.Expression_1.",Tis.tmp,"_",con.tmp,".txt"),col.names = T,row.names = F,quote = F)
    #message(paste0(nrow(df.table)))
   }
}
 for (i in 1:100){
   message(paste0(i))
   res=data_extract(i,gene = "Cry2")
   }







